<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Vue Standalone Demo – Keyframe Editor</title>

    <!-- Vue & Vuetify -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
            integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.3.6/dist/vuetify.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@3.3.6/dist/vuetify.min.css">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.x/css/materialdesignicons.min.css" rel="stylesheet"/>
</head>
<body>
<div id="app">
    <div>
        <div v-for="keyframe in keyframes" :key="keyframe.id" class="container">
            <div class="timecode">{{ keyframe.elapsed }}</div>

            <div class="flex-1">
                <v-combobox height="40px" class="ma-0 pa-0" solo density="compact"
                            :items="keyframe.candidates"
                            :menu-props="{ padding: '0px', density: 'compact' }"
                            v-model="keyframe.note"
                            @update:model-value="saveNote(keyframe)">
                </v-combobox>
            </div>
            <v-btn icon density="compact" color="red-darken-2" @click="removeKeyframe(keyframe)" class="delete-btn">
                <v-icon icon="mdi-delete"></v-icon>
            </v-btn>
        </div>
    </div>
</div>

<script>
    const {createApp} = Vue;
    const {createVuetify} = Vuetify;

    const vuetify = createVuetify();

    const app = createApp({
        data() {
            return {
                keyframes: [{
                    "id": 1,
                    "text": 1
                }]
            };
        },
        methods: {
            loadKeyframes() {
                fetch("http://localhost:8080/keyframes")
                    .then(res => res.json())
                    .then(obj => this.keyframes = obj);
            },
            saveNote(keyframe) {
                fetch("http://localhost:8080/update-note?" + new URLSearchParams({
                    id: keyframe.id,
                    note: keyframe.note
                }), {method: "POST"});
            },
            removeKeyframe(keyframe) {
                // Удаляем на сервере
                fetch("http://localhost:8080/keyframe?" + new URLSearchParams({
                    id: keyframe.id
                }), {method: "DELETE"})
                    .then(() => {
                        // Удаляем локально после успешного ответа
                        this.keyframes = this.keyframes.filter(k => k.id !== keyframe.id);
                    });
            },
            addKeyframe(record) {
                this.keyframes.push(record);
            },
            addCandidate(id, text) {
                const keyframe = this.keyframes.find(x => x.id === id);
                if (keyframe) keyframe.candidates.push(text);
            }
        },
        created() {
            this.loadKeyframes();
        }
    }).use(vuetify).mount('#app');

    const socket = io("http://localhost:8080");
    socket.on("new-keyframe", (record) => {
        app.addKeyframe(record);
    });
    socket.on("new-candidate", (id, text) => {
        app.addCandidate(id, text);
    });
</script>

<style>
    :root {
        --main-color: #fff;
        /*--element-radius: 1em;*/
        --obs-background: #3a393a;
        --obs-button-background: #4c4c4c;
        --obs-button-border: #233166;
        --obs-button-hover-background: #581624;
        --obs-button-hover-border: #84162d;
        --obs-button-color: #fff;
        --vs-line-height: 1.5;
    }

    /* Vuetify overrides */
    .v-input__details {
        display: none;
    }

    .v-list-item--density-default.v-list-item--one-line {
        padding: 0;
        min-height: 10px;
    }

    .v-list {
        padding: 0;
    }

    .v-list__tile {
        padding: 0;
    }

    body {
        font-size: 14px;
        margin: 0;
        background-color: var(--obs-background);
        font-family: "Roboto";
        color: var(--main-color);
    }

    .v-field, .v-list-item-title {
        font-size: 14px;
    }

    .container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px;
    }

    .timecode {
        padding: 0.5rem;
    }

    .flex-1 {
        flex: 1 1 0%;
    }

    .delete-btn {
        min-width: 32px;
    }

    /* Vue Select theme tweaks */
    .vs__selected {
        display: block;
        white-space: nowrap;
        text-overflow: ellipsis;
        max-width: 100%;
        overflow: hidden;
    }

    .vs__dropdown-toggle {
        background: #1f1e1f;
    }

    .vs__dropdown-option--highlight {
        background: #1f1e1f;
    }

    .vs__dropdown-menu {
        background: #7a797a;
        border: none;
        color: var(--main-color);
        text-transform: lowercase;
        font-variant: small-caps;
    }
</style>
</body>
</html>